package com.bnpparibas.dsibddf.a100919.fis.domain.pvi.model.vo;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;

import java.math.BigDecimal;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
@EnableConfigurationProperties(PviBusinessPropertiesVO.class)
@ActiveProfiles("pvi-test")
class PviBusinessPropertiesVOTest {

    @Autowired
    private PviBusinessPropertiesVO properties;

    @Test
    void shouldBindDeductionsByYearFromYaml() {
        assertThat(properties.getDeductionsByYear()).isNotNull();
        assertThat(properties.getDeductionsByYear()).containsKey(10);

        DeductionYearVO year10 = properties.getDeductionsByYear().get(10);

        assertThat(year10.IR().tauxAnnuel()).isEqualByComparingTo("6");
        assertThat(year10.IR().tauxAbattementGlobal()).isEqualByComparingTo("30");

        assertThat(year10.PS().tauxAnnuel()).isEqualByComparingTo("1.65");
        assertThat(year10.PS().tauxAbattementGlobal()).isEqualByComparingTo("8.25");
    }

    @Test
    void shouldBindCapitalGainSurtaxBracketsFromYaml() {
        assertThat(properties.getCapitalGainSurtaxBrackets()).hasSize(1);

        CapitalGainTaxBracketVO bracket =
                properties.getCapitalGainSurtaxBrackets().get(0);

        assertThat(bracket.min()).isEqualByComparingTo("50001");
        assertThat(bracket.max()).isEqualByComparingTo("60000");
        assertThat(bracket.pourcentagePlusValue()).isEqualByComparingTo("2");
        assertThat(bracket.rapport()).isEqualByComparingTo("0.05");
    }

    @Test
    void shouldBindSuggestionsFromYaml() {
        assertThat(properties.getSuggestion()).isNotNull();
        assertThat(properties.getSuggestion().getShow()).isEqualTo(4);

        assertThat(properties.getSuggestion().getSuggestions())
                .containsKey("fiscal");

        SuggestionVO suggestion =
                properties.getSuggestion()
                        .getSuggestions()
                        .get("fiscal")
                        .get(0);

        assertThat(suggestion.category()).isEqualTo("fiscal");
        assertThat(suggestion.code()).isEqualTo("PVI_SUGG_FISCAL_01");

        assertThat(suggestion.condition()).isNotNull();
        assertThat(suggestion.condition().get("operator")).isEqualTo(">");
    }
}
