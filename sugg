package com.bnpparibas.dsibddf.a100919.fis.domain.pvi.service.calculator;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.math.BigDecimal;

import static org.junit.jupiter.api.Assertions.assertEquals;

/**
 * Test d'intégration "données réelles" :
 * - utilise le bean Spring CapitalGainTaxCalculator
 * - les tranches sont chargées depuis application.yml (pvi.capitalGainSurtaxBrackets)
 * - vérifie que les résultats sont identiques à l'ancien calcul basé sur le JSON.
 */
@SpringBootTest
class CapitalGainTaxCalculatorRealDataTest {

    @Autowired
    private CapitalGainTaxCalculator calculator;

    @Test
    void shouldReturnZeroWhenPlusValueIsNullOrNonPositive() {
        assertEquals(new BigDecimal("0"), calculator.computeCapitalGainSurtax(null));
        assertEquals(new BigDecimal("0"), calculator.computeCapitalGainSurtax(new BigDecimal("0")));
        assertEquals(new BigDecimal("0"), calculator.computeCapitalGainSurtax(new BigDecimal("-1000")));
    }

    @Test
    void shouldUseFirstBracketWithZeroPercent() {
        BigDecimal tax1 = calculator.computeCapitalGainSurtax(new BigDecimal("30000"));
        BigDecimal tax2 = calculator.computeCapitalGainSurtax(new BigDecimal("50000"));

        assertEquals(new BigDecimal("0"), tax1);
        assertEquals(new BigDecimal("0"), tax2);
    }

    @Test
    void shouldUseBracketWithRapportBetween50001And60000() {
        BigDecimal taxAtMin = calculator.computeCapitalGainSurtax(new BigDecimal("50001"));
        BigDecimal taxMid   = calculator.computeCapitalGainSurtax(new BigDecimal("55000"));
        BigDecimal taxMax   = calculator.computeCapitalGainSurtax(new BigDecimal("60000"));

        assertEquals(new BigDecimal("500"), taxAtMin);
        assertEquals(new BigDecimal("850"), taxMid);
        assertEquals(new BigDecimal("1200"), taxMax);
    }

    @Test
    void shouldUseBracketWithoutRapportBetween60001And100000() {
        BigDecimal taxAtMin = calculator.computeCapitalGainSurtax(new BigDecimal("60001"));
        BigDecimal taxMid   = calculator.computeCapitalGainSurtax(new BigDecimal("80000"));
        BigDecimal taxMax   = calculator.computeCapitalGainSurtax(new BigDecimal("100000"));

        assertEquals(new BigDecimal("1200"), taxAtMin);
        assertEquals(new BigDecimal("1600"), taxMid);
        assertEquals(new BigDecimal("2000"), taxMax);
    }

    @Test
    void shouldUseBracketWithRapportBetween150001And160000() {
        BigDecimal taxAtMin = calculator.computeCapitalGainSurtax(new BigDecimal("150001"));
        BigDecimal taxMid   = calculator.computeCapitalGainSurtax(new BigDecimal("155000"));
        BigDecimal taxMax   = calculator.computeCapitalGainSurtax(new BigDecimal("160000"));

        assertEquals(new BigDecimal("4500"), taxAtMin);
        assertEquals(new BigDecimal("5450"), taxMid);
        assertEquals(new BigDecimal("6400"), taxMax);
    }

    @Test
    void shouldUseOpenEndedLastBracketForValuesAbove260000() {
        BigDecimal taxAtBorder = calculator.computeCapitalGainSurtax(new BigDecimal("260001"));
        BigDecimal taxHigh     = calculator.computeCapitalGainSurtax(new BigDecimal("300000"));

        assertEquals(new BigDecimal("15600"), taxAtBorder);
        assertEquals(new BigDecimal("18000"), taxHigh);
    }
}
