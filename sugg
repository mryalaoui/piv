@ExceptionHandler(MethodArgumentNotValidException.class)
@ResponseBody
public ResponseEntity<Object> handleMethodArgumentNotValid(final MethodArgumentNotValidException ex) {

    // Collect all errors in a readable way
    final var errors = new ArrayList<String>();

    // Dynamic code: by default, keep a generic one, then try to infer from violations
    String dynamicCode = "400-VALIDATION";
    String simulatorFromFirstError = null;

    for (final FieldError error : ex.getBindingResult().getFieldErrors()) {

        // Our format is: <SIM>|<CODE>|<MESSAGE>
        String raw = error.getDefaultMessage();

        String sim = null;
        String businessCode = null;
        String msg = raw;

        if (raw != null) {
            String[] parts = raw.split("\\|", 3);
            if (parts.length == 3) {
                sim = parts[0];
                businessCode = parts[1];
                msg = parts[2];
            }
        }

        // Determine simulator for dynamic response code
        if (simulatorFromFirstError == null && sim != null && !sim.isBlank()) {
            simulatorFromFirstError = sim;
        }

        // Build readable error list
        // Example: "PVI - saleDate : saleDate must be after or equal to acquisitionDate"
        if (sim != null && !sim.isBlank()) {
            errors.add(sim + " - " + error.getField() + " : " + msg);
        } else {
            errors.add(error.getField() + " : " + msg);
        }

        // If you want to include businessCode too in the list, use this instead:
        // errors.add(sim + " - " + error.getField() + " (" + businessCode + ") : " + msg);
    }

    // Build dynamic error code: e.g. "PVI-400-VALIDATION" or "PER-400-VALIDATION"
    if (simulatorFromFirstError != null && !simulatorFromFirstError.isBlank()) {
        dynamicCode = simulatorFromFirstError + "-400-VALIDATION";
    }

    log.info(ex.getMessage());

    return new ResponseEntity<>(ErrorModel.builder()
            .code(dynamicCode)
            .message(String.join(", ", errors))
            .description(PARAMETERS_ERROR_DESC)
            .timestamp(LocalDateTime.now())
            .build(), buildHttpHeaders(), HttpStatus.BAD_REQUEST);
}
