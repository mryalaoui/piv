package com.bnpparibas.dsibddf.a100919.fis.domain.pvi.model.vo;

import org.junit.jupiter.api.Test;

import java.math.BigDecimal;
import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

class PviBusinessPropertiesVOTest {

    @Test
    void shouldHoldAllBusinessPropertiesData() {
        // =========================
        // GIVEN
        // =========================

        // Deduction rates
        DeductionRateVO ir = new DeductionRateVO(
                new BigDecimal("6"),
                new BigDecimal("30")
        );
        DeductionRateVO ps = new DeductionRateVO(
                new BigDecimal("1.65"),
                new BigDecimal("8.25")
        );

        DeductionYearVO year10 = new DeductionYearVO(ir, ps);

        Map<Integer, DeductionYearVO> deductionsByYear =
                Map.of(10, year10);

        // Capital gain surtax bracket
        CapitalGainTaxBracketVO bracket = new CapitalGainTaxBracketVO(
                new BigDecimal("50001"),
                new BigDecimal("60000"),
                new BigDecimal("2"),
                new BigDecimal("0.05")
        );

        // Suggestion
        SuggestionVO suggestion = new SuggestionVO(
                "fiscal",
                "PVI_SUGG_FISCAL_01",
                Map.of(
                        "part1", "taxableCapitalGain",
                        "operator", ">",
                        "part2", "0"
                )
        );

        PviBusinessPropertiesVO.SuggestionProperties suggestionProperties =
                new PviBusinessPropertiesVO.SuggestionProperties();
        suggestionProperties.setShow(4);
        suggestionProperties.setSuggestions(
                Map.of("fiscal", List.of(suggestion))
        );

        // Root object
        PviBusinessPropertiesVO properties = new PviBusinessPropertiesVO();
        properties.setDeductionsByYear(deductionsByYear);
        properties.setCapitalGainSurtaxBrackets(List.of(bracket));
        properties.setSuggestion(suggestionProperties);

        // =========================
        // THEN
        // =========================

        assertThat(properties.getDeductionsByYear()).isNotNull();
        assertThat(properties.getDeductionsByYear()).containsKey(10);

        DeductionYearVO loadedYear = properties.getDeductionsByYear().get(10);
        assertThat(loadedYear.IR().tauxAnnuel()).isEqualByComparingTo("6");
        assertThat(loadedYear.PS().tauxAnnuel()).isEqualByComparingTo("1.65");

        assertThat(properties.getCapitalGainSurtaxBrackets()).hasSize(1);
        CapitalGainTaxBracketVO loadedBracket =
                properties.getCapitalGainSurtaxBrackets().get(0);

        assertThat(loadedBracket.min()).isEqualByComparingTo("50001");
        assertThat(loadedBracket.max()).isEqualByComparingTo("60000");
        assertThat(loadedBracket.pourcentagePlusValue()).isEqualByComparingTo("2");
        assertThat(loadedBracket.rapport()).isEqualByComparingTo("0.05");

        assertThat(properties.getSuggestion()).isNotNull();
        assertThat(properties.getSuggestion().getShow()).isEqualTo(4);

        assertThat(properties.getSuggestion().getSuggestions())
                .containsKey("fiscal");

        SuggestionVO loadedSuggestion =
                properties.getSuggestion().getSuggestions().get("fiscal").get(0);

        assertThat(loadedSuggestion.category()).isEqualTo("fiscal");
        assertThat(loadedSuggestion.code()).isEqualTo("PVI_SUGG_FISCAL_01");
        assertThat(loadedSuggestion.condition()).isNotNull();
    }
}
