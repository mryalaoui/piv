package com.bnpparibas.dsibddf.a100919.fis.domain.pvi.config;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;

import java.math.BigDecimal;
import java.util.List;
import java.util.Map;

/**
 * Business configuration bean for the PVI simulator.
 * Bound to the "pvi" prefix in application.yml.package com.bnpparibas.dsibddf.a100919.fis;

import com.bnpparibas.dsibddf.a100919.fis.domain.pvi.config.PviBusinessProperties;
import com.bnpparibas.dsibddf.a100919.fis.domain.pvi.config.PviBusinessProperties.AbatementProperties;
import com.bnpparibas.dsibddf.a100919.fis.domain.pvi.config.PviBusinessProperties.SurtaxBracket;
import com.bnpparibas.dsibddf.a100919.fis.domain.pvi.config.PviBusinessProperties.SuggestionProperties;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.math.BigDecimal;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * Integration test to validate that PviBusinessProperties
 * is correctly bound from application.yml.
 */
@SpringBootTest
class PviBusinessPropertiesIT {

    @Autowired
    private PviBusinessProperties pviBusinessProperties;

    @Test
    void shouldLoadPviBusinessPropertiesFromYaml() {
        assertThat(pviBusinessProperties).isNotNull();

        // ----------------- Abatement -----------------
        AbatementProperties abatement = pviBusinessProperties.getAbatement();
        assertThat(abatement).isNotNull();
        assertThat(abatement.getYears()).isNotEmpty();

        // Year "6" from YAML:
        var year6 = abatement.getYears().get("6");
        assertThat(year6).isNotNull();
        assertThat(year6.getIr().getAnnualRate())
                .as("IR annualRate for year 6")
                .isEqualByComparingTo(BigDecimal.valueOf(6));
        assertThat(year6.getPs().getGlobalAllowanceRate())
                .as("PS globalAllowanceRate for year 6")
                .isEqualByComparingTo(BigDecimal.valueOf(1.65));

        // ----------------- Surtax brackets -----------------
        assertThat(pviBusinessProperties.getSurtaxBrackets())
                .as("surtaxBrackets should not be empty")
                .isNotEmpty();

        SurtaxBracket firstBracket = pviBusinessProperties.getSurtaxBrackets().get(0);
        assertThat(firstBracket.getMin())
                .as("first bracket min")
                .isEqualByComparingTo(BigDecimal.ZERO);
        assertThat(firstBracket.getMax())
                .as("first bracket max")
                .isEqualByComparingTo(BigDecimal.valueOf(50000));
        assertThat(firstBracket.getPlusValuePercent())
                .as("first bracket plusValuePercent")
                .isEqualByComparingTo(BigDecimal.ZERO);

        // ----------------- Suggestions -----------------
        SuggestionProperties suggestion = pviBusinessProperties.getSuggestion();
        assertThat(suggestion).isNotNull();
        assertThat(suggestion.getShow()).isEqualTo(4);
        assertThat(suggestion.getSuggestions()).isNotEmpty();

        var fiscalSuggestions = suggestion.getSuggestions().get("fiscal");
        assertThat(fiscalSuggestions)
                .as("fiscal suggestions should not be empty")
                .isNotEmpty();

        // Example: first fiscal suggestion code should be PVI_FIS_01
        assertThat(fiscalSuggestions.get(0).getCode())
                .as("first fiscal suggestion code")
                .isEqualTo("PVI_FIS_01");
    }
}

 */
@Data
@ConfigurationProperties(prefix = "pvi")
public class PviBusinessProperties {

    private AbatementProperties abatement;
    private List<SurtaxBracket> surtaxBrackets;
    private SuggestionProperties suggestion;

    // -------------------------------------------------------------------------
    // 1. ABATEMENT CONFIGURATION
    // -------------------------------------------------------------------------
    @Data
    public static class AbatementProperties {
        /**
         * Key = holding period in years ("0", "1", ..., "30").
         */
        private Map<String, YearAbatement> years;
    }

    @Data
    public static class YearAbatement {
        private TaxAbatement ir; // Income tax abatement
        private TaxAbatement ps; // Social contribution abatement
    }

    @Data
    public static class TaxAbatement {
        private BigDecimal annualRate;
        private BigDecimal globalAllowanceRate;
    }

    // -------------------------------------------------------------------------
    // 2. SURTAX BRACKETS (texe-pvi.json)
    // -------------------------------------------------------------------------
    @Data
    public static class SurtaxBracket {
        private BigDecimal min;
        private BigDecimal max;
        private BigDecimal plusValuePercent;
        private BigDecimal ratio;
    }

    // -------------------------------------------------------------------------
    // 3. SUGGESTIONS
    // -------------------------------------------------------------------------
    @Data
    public static class SuggestionProperties {
        /**
         * Max number of suggestions to show.
         */
        private int show;

        /**
         * Key = category ("general", "financier", "juridique", "fiscal").
         */
        private Map<String, List<SuggestionItem>> suggestions;
    }

    @Data
    public static class SuggestionItem {
        /**
         * Functional code sent to the frontend (e.g. PVI_FIS_03).
         */
        private String code;

        /**
         * Optional condition to evaluate before displaying the suggestion.
         */
        private Condition condition;
    }

    /**
     * Generic condition.
     *
     * - Simple case:
     *   part1 = field name, operator = ">", part2 = value
     *
     * - Composite case (e.g. OR condition for PVI_FIS_05):
     *   part1 and/or part2 are themselves sub-conditions represented as maps.
     */
    @Data
    public static class Condition {
        private Object part1;
        private String operator;
        private Object part2;
    }
}
