1Ô∏è‚É£ Fabrique de propri√©t√©s (r√©utilisable)

üëâ Tr√®s important : on isole la construction des donn√©es
‚Üí √ßa √©vite de polluer le test.

üìÑ PviBusinessPropertiesTestFactory.java
package com.bnpparibas.dsibddf.a100919.fis.domain.pvi.test;

import com.bnpparibas.dsibddf.a100919.fis.domain.pvi.model.vo.*;

import java.math.BigDecimal;
import java.util.List;
import java.util.Map;

public final class PviBusinessPropertiesTestFactory {

    private PviBusinessPropertiesTestFactory() {}

    public static PviBusinessPropertiesVO build() {

        // ================== DEDUCTIONS ==================
        DeductionRateVO ir = new DeductionRateVO(
                new BigDecimal("6"),
                new BigDecimal("30")
        );
        DeductionRateVO ps = new DeductionRateVO(
                new BigDecimal("1.65"),
                new BigDecimal("8.25")
        );

        Map<Integer, DeductionYearVO> deductionsByYear = Map.of(
                10, new DeductionYearVO(ir, ps)
        );

        // ================== SURTAXE ==================
        CapitalGainTaxBracketVO bracket = new CapitalGainTaxBracketVO(
                new BigDecimal("50001"),
                new BigDecimal("60000"),
                new BigDecimal("2"),
                new BigDecimal("0.05")
        );

        // ================== SUGGESTIONS ==================
        SuggestionVO fiscalSuggestion = new SuggestionVO(
                "fiscal",
                "PVI_SUGG_FISCAL_01",
                Map.of(
                        "part1", "taxableCapitalGain",
                        "operator", ">",
                        "part2", "0"
                )
        );

        PviBusinessPropertiesVO.SuggestionProperties suggestionProperties =
                new PviBusinessPropertiesVO.SuggestionProperties();
        suggestionProperties.setShow(4);
        suggestionProperties.setSuggestions(
                Map.of("fiscal", List.of(fiscalSuggestion))
        );

        // ================== ROOT ==================
        PviBusinessPropertiesVO vo = new PviBusinessPropertiesVO();
        vo.setDeductionsByYear(deductionsByYear);
        vo.setCapitalGainSurtaxBrackets(List.of(bracket));
        vo.setSuggestion(suggestionProperties);

        return vo;
    }
}


üëâ Cette classe est cl√© :

claire

maintenable

align√©e avec le YAML

r√©utilisable dans plusieurs TU

2Ô∏è‚É£ Test unitaire de SuggestionEngine (sans Spring)
üìÑ SuggestionEngineTest.java
package com.bnpparibas.dsibddf.a100919.fis.domain.pvi.service.engine;

import com.bnpparibas.dsibddf.a100919.fis.domain.pvi.model.dto.PviSimulationRequest;
import com.bnpparibas.dsibddf.a100919.fis.domain.pvi.model.result.PviSimulationResult;
import com.bnpparibas.dsibddf.a100919.fis.domain.pvi.model.vo.PviBusinessPropertiesVO;
import com.bnpparibas.dsibddf.a100919.fis.domain.pvi.model.vo.SuggestionVO;
import com.bnpparibas.dsibddf.a100919.fis.domain.pvi.test.PviBusinessPropertiesTestFactory;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.math.BigDecimal;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;

class SuggestionEngineTest {

    private SuggestionEngine engine;

    @BeforeEach
    void setUp() {
        PviBusinessPropertiesVO properties =
                PviBusinessPropertiesTestFactory.build();

        engine = new SuggestionEngine(properties);
        engine.init(); // ‚ö†Ô∏è IMPORTANT : init manuel
    }

    @Test
    void shouldReturnSuggestionWhenConditionIsSatisfied() {
        // GIVEN
        PviSimulationRequest req = PviSimulationRequest.builder()
                .build();

        PviSimulationResult result = PviSimulationResult.builder()
                .taxableCapitalGain(new BigDecimal("60000"))
                .build();

        // WHEN
        List<SuggestionVO> suggestions =
                engine.computeSuggestions(req, result);

        // THEN
        assertThat(suggestions).isNotEmpty();
        assertThat(suggestions.get(0).code())
                .isEqualTo("PVI_SUGG_FISCAL_01");
    }

    @Test
    void shouldReturnNoSuggestionWhenConditionIsNotSatisfied() {
        PviSimulationRequest req = PviSimulationRequest.builder().build();

        PviSimulationResult result = PviSimulationResult.builder()
                .taxableCapitalGain(BigDecimal.ZERO)
                .build();

        List<SuggestionVO> suggestions =
                engine.computeSuggestions(req, result);

        assertThat(suggestions).isEmpty();
    }
}
