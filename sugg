package com.bnpparibas.dsibddf.a100919.fis.domain.pvi.model.vo;

import org.junit.jupiter.api.Test;

import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;

class SuggestionVOTest {

    @Test
    void shouldCreateSimpleSuggestionWithoutCondition() {
        // given
        String category = "fiscal";
        String value    = "PVI_SUGG_FISCAL_01_VALUE";
        String url      = "PVI_SUGG_FISCAL_01_URL";

        // when
        SuggestionVO vo = new SuggestionVO(category, value, url, null);

        // then
        assertEquals(category, vo.category());
        assertEquals(value, vo.value());
        assertEquals(url, vo.url());
        assertNull(vo.condition(), "La condition doit être null quand non renseignée");
    }

    @Test
    void shouldCreateSuggestionWithSimpleCondition() {
        // given
        Map<String, Object> condition = Map.of(
                "part1", "taxableCapitalGain",
                "operator", ">",
                "part2", "50000"
        );

        // when
        SuggestionVO vo = new SuggestionVO(
                "fiscal",
                "PVI_SUGG_FISCAL_SURTAXE_VALUE",
                "PVI_SUGG_FISCAL_SURTAXE_URL",
                condition
        );

        // then
        assertNotNull(vo.condition());
        assertEquals("taxableCapitalGain", vo.condition().get("part1"));
        assertEquals(">", vo.condition().get("operator"));
        assertEquals("50000", vo.condition().get("part2"));
    }

    @Test
    @SuppressWarnings("unchecked")
    void shouldSupportCompositeConditionTree() {
        // given : (propertyUse == 'secondary-residence' || propertyUse == 'location')

        Map<String, Object> leftCond = Map.of(
                "part1", "propertyUse",
                "operator", "==",
                "part2", "secondary-residence"
        );

        Map<String, Object> rightCond = Map.of(
                "part1", "propertyUse",
                "operator", "==",
                "part2", "location"
        );

        Map<String, Object> rootCondition = Map.of(
                "part1", leftCond,
                "operator", "||",
                "part2", rightCond
        );

        // when
        SuggestionVO vo = new SuggestionVO(
                "fiscal",
                "PVI_SUGG_FISCAL_FIRST_DISPOSAL_VALUE",
                "PVI_SUGG_FISCAL_FIRST_DISPOSAL_URL",
                rootCondition
        );

        // then
        assertNotNull(vo.condition());
        assertEquals("||", vo.condition().get("operator"));

        Map<String, Object> part1 = (Map<String, Object>) vo.condition().get("part1");
        Map<String, Object> part2 = (Map<String, Object>) vo.condition().get("part2");

        assertEquals("propertyUse", part1.get("part1"));
        assertEquals("==", part1.get("operator"));
        assertEquals("secondary-residence", part1.get("part2"));

        assertEquals("propertyUse", part2.get("part1"));
        assertEquals("==", part2.get("operator"));
        assertEquals("location", part2.get("part2"));
    }
}
